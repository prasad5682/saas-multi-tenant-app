require('dotenv').config();const express=require('express'),cors=require('cors'),{Pool}=require('pg'),jwt=require('jsonwebtoken'),bcrypt=require('bcryptjs'),{v4:uuid}=require('uuid'),app=express();app.use(cors({origin:process.env.FRONTEND_URL||'http://localhost:3000'})),app.use(express.json());const pool=new Pool({user:process.env.DB_USER||'postgres',password:process.env.DB_PASSWORD||'postgres',host:process.env.DB_HOST||'database',port:process.env.DB_PORT||5432,database:process.env.DB_NAME||'saas_db'});app.get('/api/health',async(req,res)=>{try{await pool.query('SELECT NOW()');res.json({status:'ok',database:'connected'})}catch(e){res.status(503).json({status:'error'})}});const auth=(req,res,nxt)=>{const token=req.headers['authorization']?.split(' ')[1];if(!token)return res.status(401).json({success:!1,message:'No token'});jwt.verify(token,process.env.JWT_SECRET||'secret',(e,decoded)=>{if(e)return res.status(401).json({success:!1,message:'Invalid'});req.user=decoded,nxt()})};app.post('/api/auth/register-tenant',async(req,res)=>{const{tenantName:name,subdomain:sub,adminEmail:email,adminPassword:pwd,adminFullName:full}=req.body;if(!name||!sub||!email||!pwd)return res.status(400).json({success:!1});const client=await pool.connect();try{await client.query('BEGIN');const tid=uuid(),uid=uuid(),hash=await bcrypt.hash(pwd,10);await client.query('INSERT INTO tenants(id,name,subdomain,status,subscription_plan,max_users,max_projects,created_at,updated_at)VALUES($1,$2,$3,$4,$5,$6,$7,NOW(),NOW())',[tid,name,sub,'active','free',5,3]),await client.query('INSERT INTO users(id,tenant_id,email,password_hash,full_name,role,is_active,created_at,updated_at)VALUES($1,$2,$3,$4,$5,$6,$7,NOW(),NOW())',[uid,tid,email,hash,full,'tenant_admin',!0]),await client.query('COMMIT'),res.status(201).json({success:!0,data:{tenantId:tid,subdomain:sub}})}catch(e){await client.query('ROLLBACK'),res.status(409).json({success:!1,message:'Failed'})}finally{client.release()}});app.post('/api/auth/login',async(req,res)=>{const{email:em,password:pw,tenantSubdomain:sub}=req.body;try{const t=await pool.query('SELECT id FROM tenants WHERE subdomain=$1',[sub]);if(!t.rows.length)return res.status(404).json({success:!1});const u=await pool.query('SELECT * FROM users WHERE email=$1 AND tenant_id=$2',[em,t.rows[0].id]);if(!u.rows.length)return res.status(401).json({success:!1});const ok=await bcrypt.compare(pw,u.rows[0].password_hash);if(!ok)return res.status(401).json({success:!1});const token=jwt.sign({userId:u.rows[0].id,tenantId:u.rows[0].tenant_id,role:u.rows[0].role},process.env.JWT_SECRET||'secret',{expiresIn:'24h'});res.json({success:!0,data:{user:u.rows[0],token,expiresIn:86400}})}catch(e){res.status(500).json({success:!1})}});app.get('/api/auth/me',auth,async(req,res)=>{try{const u=await pool.query('SELECT * FROM users WHERE id=$1',[req.user.userId]);res.json({success:!!u.rows.length,data:u.rows[0]})}catch(e){res.status(500).json({success:!1})}});app.post('/api/auth/logout',auth,async(req,res)=>{res.json({success:!0,message:'Logged out'})});app.get('/api/tenants/:tid',auth,async(req,res)=>{try{const t=await pool.query('SELECT * FROM tenants WHERE id=$1',[req.params.tid]);res.json({success:!!t.rows.length,data:t.rows[0]})}catch(e){res.status(500).json({success:!1})}});app.get('/api/tenants/:tid/users',auth,async(req,res)=>{try{const u=await pool.query('SELECT * FROM users WHERE tenant_id=$1',[req.params.tid]);res.json({success:!0,data:{users:u.rows,total:u.rows.length}})}catch(e){res.status(500).json({success:!1})}});app.post('/api/tenants/:tid/users',auth,async(req,res)=>{const{email:em,password:pw,fullName:full,role:r}=req.body;try{const hash=await bcrypt.hash(pw,10),uid=uuid();await pool.query('INSERT INTO users(id,tenant_id,email,password_hash,full_name,role,is_active,created_at,updated_at)VALUES($1,$2,$3,$4,$5,$6,$7,NOW(),NOW())',[uid,req.params.tid,em,hash,full,r||'user',!0]),res.status(201).json({success:!0,data:{id:uid}})}catch(e){res.status(409).json({success:!1,message:'Email exists'})}});app.post('/api/projects',auth,async(req,res)=>{const{name:nm,description:desc}=req.body;try{const pid=uuid();await pool.query('INSERT INTO projects(id,tenant_id,name,description,status,created_by,created_at,updated_at)VALUES($1,$2,$3,$4,$5,$6,NOW(),NOW())',[pid,req.user.tenantId,nm,desc,'active',req.user.userId]),res.status(201).json({success:!0,data:{id:pid}})}catch(e){res.status(500).json({success:!1})}});app.get('/api/projects',auth,async(req,res)=>{try{const p=await pool.query('SELECT * FROM projects WHERE tenant_id=$1',[req.user.tenantId]);res.json({success:!0,data:{projects:p.rows}})}catch(e){res.status(500).json({success:!1})}});app.post('/api/projects/:pid/tasks',auth,async(req,res)=>{const{title:t,description:d,priority:pr}=req.body,taskId=uuid();try{await pool.query('INSERT INTO tasks(id,project_id,tenant_id,title,description,status,priority,created_at,updated_at)VALUES($1,$2,$3,$4,$5,$6,$7,NOW(),NOW())',[taskId,req.params.pid,req.user.tenantId,t,d,'todo',pr||'medium']),res.status(201).json({success:!0,data:{id:taskId}})}catch(e){res.status(500).json({success:!1})}});app.get('/api/projects/:pid/tasks',auth,async(req,res)=>{try{const tasks=await pool.query('SELECT * FROM tasks WHERE project_id=$1 AND tenant_id=$2',[req.params.pid,req.user.tenantId]);res.json({success:!0,data:{tasks:tasks.rows}})}catch(e){res.status(500).json({success:!1})}});app.patch('/api/tasks/:id/status',auth,async(req,res)=>{const{status:s}=req.body;try{await pool.query('UPDATE tasks SET status=$1 WHERE id=$2',[s,req.params.id]),res.json({success:!0})}catch(e){res.status(500).json({success:!1})}});const PORT=process.env.PORT||5000;app.listen(PORT,()=>console.log(`Server on ${PORT}`))
